name: Update Repository Metadata

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch: # Allow manual triggers

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - id: get-workflow-access-token
        name: Get Workflow Access Token
        uses: actions/create-github-app-token@0d564482f06ca65fa9e77e2510873638c82206f2 # v1.11.5
        with:
          app-id: ${{ secrets.APPLICATION_ID }}
          private-key: ${{ secrets.APPLICATION_PRIVATE_KEY }}

      - name: Setup Git user
        run: |
          git config --global user.email '118100583+bfra-me[bot]@users.noreply.github.com'
          git config --global user.name 'bfra-me[bot]'

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.get-workflow-access-token.outputs.token }}

      - name: Install pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4.2.0
        with:
          cache: pnpm
          node-version-file: .node-version

      - name: Install dependencies
        run: pnpm bootstrap

      - name: Generate metadata
        env:
          GH_TOKEN: ${{ steps.get-workflow-access-token.outputs.token }}
        run: pnpm update-metadata

      - name: Autofix linting errors
        run: pnpm fix

      - name: Create changeset
        run: |
          # Create a changeset with a unique filename in the correct format
          cat > .changeset/update-metadata-$(date +%s).md <<EOF
          ---
          '@bfra.me/.github': patch
          ---
          Update repository metadata files based on the latest organization scan.
          EOF

      - name: Create Pull Request
        if: github.ref == 'refs/heads/main'
        uses: peter-evans/create-pull-request@dd2324fc52d5d43c699a5636bcf19fceaa70c284 # v7.0.7
        with:
          body: |
            This PR updates the repository metadata files based on the latest organization scan.
            Please review the changes and merge this pull request if you approve.

            <sup>
            _This PR is automatically generated by the [update-metadata workflow][1] ([#${{ github.run_number }}][2])._
            </sup>

            [1]: https://github.com/${{ github.repository }}/blob/main/.github/workflows/update-metadata.yaml 'Update Metadata Workflow'
            [2]: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }} 'Workflow Run'
          branch: ci/update-metadata
          commit-message: 'chore: update repository metadata'
          committer: 'bfra-me[bot] <118100583+bfra-me[bot]@users.noreply.github.com>'
          delete-branch: true
          sign-commits: true
          title: 'chore: update repository metadata'
          token: ${{ steps.get-workflow-access-token.outputs.token }}
